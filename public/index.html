<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>å…­åˆå½©æ”ªç çµæœ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .year-selector label {
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .year-selector input {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 120px;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .year-selector input:focus {
            outline: none;
            border-color: #667eea;
        }

        .fetch-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .fetch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .fetch-button:active {
            transform: translateY(0);
        }

        .fetch-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }


        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .results-container {
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover {
            background: #f5f5f5;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .number-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 2px;
            font-weight: 600;
        }

        .stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .stats p {
            margin: 5px 0;
            color: #666;
        }

        /* Mobile Responsive Styles */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
                padding-top: max(10px, env(safe-area-inset-top));
                padding-bottom: max(10px, env(safe-area-inset-bottom));
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
            }

            .container {
                padding: 15px;
                border-radius: 10px;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }

            .year-selector {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }

            .year-selector label {
                font-size: 14px;
            }

            .year-selector input {
                width: 100%;
                max-width: 200px;
                padding: 12px;
                font-size: 16px;
                /* Prevent zoom on iOS */
                min-height: 44px;
                /* iOS touch target minimum */
                -webkit-appearance: none;
                appearance: none;
            }

            .fetch-button {
                width: 100%;
                max-width: 100%;
                padding: 14px 20px;
                font-size: 16px;
                margin-top: 10px;
                min-height: 44px;
                /* iOS touch target minimum */
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.3);
            }

            .action-buttons {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }

            .action-buttons .fetch-button {
                width: 100%;
            }

            .results-table {
                font-size: 14px;
            }

            .number-badge {
                font-size: 14px;
                padding: 4px 10px;
                margin: 3px;
            }

            .stats {
                padding: 15px;
                font-size: 14px;
            }

            .stats h2,
            .stats h3 {
                font-size: 1.3em;
            }
        }

        @media screen and (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }

            .container {
                padding: 12px;
            }

            .fetch-button {
                padding: 12px 18px;
                font-size: 15px;
            }

            .results-table {
                font-size: 13px;
            }
        }

        /* Make tables scrollable on mobile */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
            width: 100%;
        }

        @media screen and (max-width: 768px) {
            .table-wrapper {
                margin: 15px -12px;
                padding: 0 12px;
            }

            .table-wrapper table {
                min-width: 600px;
            }

            .results-table {
                font-size: 13px;
            }

            .results-table th,
            .results-table td {
                padding: 10px 8px;
            }
        }

        /* Adjust prediction cards for mobile */
        @media screen and (max-width: 768px) {
            .prediction-cards {
                gap: 10px !important;
                justify-content: center !important;
            }

            .prediction-card {
                min-width: calc(33.333% - 7px) !important;
                max-width: calc(33.333% - 7px) !important;
                padding: 15px !important;
                flex: 0 0 calc(33.333% - 7px) !important;
                font-size: 12px !important;
            }
        }

        @media screen and (max-width: 480px) {
            .prediction-card {
                min-width: calc(50% - 5px) !important;
                max-width: calc(50% - 5px) !important;
                flex: 0 0 calc(50% - 5px) !important;
                padding: 12px !important;
                font-size: 11px !important;
            }

            .prediction-card>div:first-child {
                font-size: 10px !important;
            }

            .prediction-card>div:nth-child(2) {
                font-size: 18px !important;
            }

            .prediction-card>div:last-child {
                font-size: 9px !important;
            }
        }

        /* iPhone 17 specific adjustments */
        @media screen and (max-width: 430px) {
            .prediction-card {
                min-width: calc(50% - 5px) !important;
                max-width: calc(50% - 5px) !important;
                flex: 0 0 calc(50% - 5px) !important;
                padding: 10px !important;
            }
        }

        /* Grid adjustments for mobile */
        @media screen and (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }

            .weight-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>å…­åˆå½©æ”ªç çµæœ</h1>

        <div class="button-container">
            <div class="year-selector">
                <label for="startYear">å¹´ä»½ï¼š</label>
                <input type="number" id="startYear" min="2000" max="2100" value="">
                <label for="endYear">è‡³</label>
                <input type="number" id="endYear" min="2000" max="2100" value="">
            </div>
            <button class="fetch-button" id="fetchButton" onclick="fetchLotteryResults()">
                å–å¾—æ”ªç çµæœ
            </button>
            <div class="action-buttons">
                <button class="fetch-button" id="analysisButton" onclick="showAnalysis()" style="display: none;">
                    åˆ†æ
                </button>
                <button class="fetch-button" id="validateButton" onclick="showValidation()" style="display: none;">
                    è¿­ä»£é©—è­‰
                </button>
                <button class="fetch-button" id="predictButton" onclick="showLatestPrediction()"
                    style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    ğŸ¯ æœ€æ–°é æ¸¬
                </button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">æ­£åœ¨è™•ç†ä¸­...</div>
            <div id="progressContainer" style="width: 100%; max-width: 500px; margin: 20px auto 0; display: none;">
                <div style="background: #e0e0e0; border-radius: 10px; height: 25px; overflow: hidden; position: relative;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 10px;"></div>
                </div>
                <div id="progressText" style="margin-top: 10px; font-size: 14px; color: #666; text-align: center;"></div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="resultsContainer" class="results-container"></div>
    </div>

    <script>
        // å„²å­˜ç•¶å‰çµæœè³‡æ–™
        let currentResults = [];

        /**
         * è§£ææœŸæ•¸å­—ä¸²ç‚ºå¹´ä»½å’ŒæœŸæ•¸å°è±¡
         * æ”¯æ´æ ¼å¼ï¼š25/132 (å¹´ä»½/æœŸæ•¸) æˆ– 2025001 (å¹´ä»½+æœŸæ•¸)
         * @param {string} periodNumber - æœŸæ•¸å­—ä¸²
         * @param {Object} options - é¸é …
         * @param {boolean} options.convertYear - æ˜¯å¦å°‡2ä½æ•¸å¹´ä»½è½‰æ›ç‚º4ä½æ•¸ï¼ˆé»˜èªfalseï¼‰
         * @param {boolean} options.returnNull - è§£æå¤±æ•—æ™‚è¿”å›nullè€Œä¸æ˜¯é»˜èªå€¼ï¼ˆé»˜èªfalseï¼‰
         * @returns {Object|null} {year: number, period: number} æˆ– null
         */
        function parsePeriodNumber(periodNumber, options = {}) {
            const { convertYear = false, returnNull = false } = options;

            if (!periodNumber) {
                return returnNull ? null : { year: 0, period: 0 };
            }

            // æ ¼å¼ 25/132 (å¹´ä»½/æœŸæ•¸)
            const match1 = periodNumber.match(/^(\d{2})\/(\d+)$/);
            if (match1) {
                let year = parseInt(match1[1], 10);
                const period = parseInt(match1[2], 10);

                // å¦‚æœéœ€è¦è½‰æ›å¹´ä»½ï¼Œå°‡2ä½æ•¸å¹´ä»½è½‰æ›ç‚º4ä½æ•¸ï¼ˆå‡è¨­25ä»£è¡¨2025ï¼‰
                if (convertYear) {
                    year = year < 50 ? 2000 + year : 1900 + year;
                }

                return { year: year, period: period };
            }

            // æ ¼å¼ 2025001 (å¹´ä»½+æœŸæ•¸) æˆ– 2025001 (å¹´ä»½+3ä½æœŸæ•¸)
            const match2 = periodNumber.match(/^(\d{4})(\d+)$/);
            if (match2) {
                const year = parseInt(match2[1], 10);
                const period = parseInt(match2[2], 10);
                return { year: year, period: period };
            }

            return returnNull ? null : { year: 0, period: 0 };
        }

        // åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨ï¼Œé è¨­ç‚ºä»Šå¹´
        document.addEventListener('DOMContentLoaded', function () {
            const currentYear = new Date().getFullYear();
            document.getElementById('startYear').value = currentYear;
            document.getElementById('endYear').value = currentYear;
        });

        async function fetchLotteryResults() {
            const button = document.getElementById('fetchButton');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;

            // é©—è­‰å¹´ä»½è¼¸å…¥
            if (!startYear || !endYear) {
                error.textContent = 'éŒ¯èª¤: è«‹è¼¸å…¥é–‹å§‹å¹´ä»½å’ŒçµæŸå¹´ä»½';
                error.style.display = 'block';
                return;
            }

            if (parseInt(startYear) > parseInt(endYear)) {
                error.textContent = 'éŒ¯èª¤: é–‹å§‹å¹´ä»½ä¸èƒ½å¤§æ–¼çµæŸå¹´ä»½';
                error.style.display = 'block';
                return;
            }

            // é‡ç½®ç‹€æ…‹
            button.disabled = true;
            loading.style.display = 'flex';
            document.getElementById('loadingText').textContent = 'æ­£åœ¨å–å¾—è³‡æ–™...';
            error.style.display = 'none';
            resultsContainer.innerHTML = '';
            // Hide analysis, validation and prediction buttons when fetching new data
            document.getElementById('analysisButton').style.display = 'none';
            document.getElementById('validateButton').style.display = 'none';
            document.getElementById('predictButton').style.display = 'none';

            try {
                const url = `/api/lottery/results?startYear=${startYear}&endYear=${endYear}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // å„²å­˜çµæœè³‡æ–™ä¾›åˆ†æä½¿ç”¨
                    currentResults = data.data;
                    displayResults(data.data, data.count);
                    // Show analysis, validation and prediction buttons after successful fetch
                    document.getElementById('analysisButton').style.display = 'block';
                    document.getElementById('validateButton').style.display = 'block';
                    document.getElementById('predictButton').style.display = 'block';
                } else {
                    throw new Error(data.message || 'å–å¾—è³‡æ–™å¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayResults(results, count) {
            const container = document.getElementById('resultsContainer');

            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš«ç„¡è³‡æ–™</p>';
                return;
            }

            let html = `
                <div class="stats">
                    <p><strong>å…±å–å¾— ${count} ç­†è¨˜éŒ„</strong></p>
                </div>
                <div class="table-wrapper">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>æ”ªç æœŸæ•¸</th>
                                <th>æ”ªç æ—¥æœŸ</th>
                                <th>æ”ªå‡ºè™Ÿç¢¼</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            results.forEach(result => {
                // Extract numbers from the string format
                let numberArray = [];
                if (result.numbers && result.numbers.length > 0) {
                    if (typeof result.numbers[0] === 'string') {
                        // Split by newlines and tabs, filter out empty strings, and parse numbers
                        numberArray = result.numbers[0]
                            .split(/[\n\t]+/)
                            .filter(str => str.trim() !== '')
                            .map(str => parseInt(str.trim(), 10))
                            .filter(num => !isNaN(num));
                    } else {
                        // If it's already an array of numbers, use it directly
                        numberArray = result.numbers;
                    }
                }

                const numbers = numberArray.map(num =>
                    `<span class="number-badge">${num}</span>`
                ).join('');

                html += `
                    <tr>
                        <td data-label="æ”ªç æœŸæ•¸">${result.periodNumber}</td>
                        <td data-label="æ”ªç æ—¥æœŸ">${result.date}</td>
                        <td data-label="æ”ªå‡ºè™Ÿç¢¼">${numbers || 'ç„¡'}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        async function showAnalysis() {
            const analysisButton = document.getElementById('analysisButton');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');

            if (currentResults.length === 0) {
                error.textContent = 'éŒ¯èª¤: è«‹å…ˆå–å¾—æ”ªç çµæœ';
                error.style.display = 'block';
                return;
            }

            // é‡ç½®ç‹€æ…‹
            analysisButton.disabled = true;
            error.style.display = 'none';
            loading.style.display = 'flex';
            document.getElementById('loadingText').textContent = 'æ­£åœ¨åˆ†æè™Ÿç¢¼...';

            try {
                const response = await fetch('/api/lottery/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayAnalysisResults(data.data);
                } else {
                    throw new Error(data.message || 'åˆ†æå¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                analysisButton.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayAnalysisResults(analysisData) {
            const container = document.getElementById('resultsContainer');

            let html = `
                <div class="stats">
                    <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š åˆ†æçµæœ</h2>
                    <p><strong>åˆ†ææœŸæ•¸:</strong> ${analysisData.stats.totalPeriods} æœŸ</p>
                    <p><strong>ç¸½æŠ½ä¸­æ¬¡æ•¸:</strong> ${analysisData.stats.totalNumbers} æ¬¡</p>
                    <p><strong>å¹³å‡å‡ºç¾é »ç‡:</strong> ${Math.round(analysisData.stats.averageFrequency * 100) / 100} æ¬¡/è™Ÿç¢¼</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">
                        ğŸ¯ é æ¸¬ä¸‹ä¸€æœŸæœ€æœ‰å¯èƒ½å‡ºç¾çš„ 10 å€‹è™Ÿç¢¼
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;">
            `;

            // é¡¯ç¤ºå‰ 10 åè™Ÿç¢¼
            html += `<div class="prediction-cards" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px; justify-content: center;">`;
            analysisData.topNumbers.forEach((item, index) => {
                const rank = index + 1;
                const size = rank <= 3 ? '25px' : '20px'; // å‰ä¸‰åç¨å¤§
                const bgColor = rank === 1 ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                    rank === 2 ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' :
                        rank === 3 ? 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' :
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

                html += `
                    <div class="prediction-card" style="
                        background: ${bgColor};
                        color: white;
                        padding: 20px;
                        border-radius: 15px;
                        text-align: center;
                        min-width: 120px;
                        flex: 1 1 calc(33.333% - 10px);
                        max-width: calc(33.333% - 10px);
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        transition: transform 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">æ’å #${rank}</div>
                        <div style="font-size: ${size}; font-weight: bold; margin: 10px 0;">${item.number}</div>
                        <div style="font-size: 11px; opacity: 0.8;">ç¶œåˆåˆ†æ•¸: ${item.score}</div>
                    </div>
                `;
            });
            html += `</div>`;

            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“ˆ è©³ç´°çµ±è¨ˆ</h3>
                    <div class="table-wrapper">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>è™Ÿç¢¼</th>
                                    <th>ç¶œåˆåˆ†æ•¸</th>
                                    <th>ç¸½å‡ºç¾æ¬¡æ•¸</th>
                                    <th>åŠ æ¬Šé »ç‡</th>
                                    <th>é–“éš”åˆ†æ•¸</th>
                                    <th>æ¨¡å¼åˆ†æ•¸</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            analysisData.topNumbers.forEach((item, index) => {
                html += `
                    <tr>
                        <td data-label="æ’å"><strong>#${index + 1}</strong></td>
                        <td data-label="è™Ÿç¢¼"><span class="number-badge" style="font-size: 16px;">${item.number}</span></td>
                        <td data-label="ç¶œåˆåˆ†æ•¸">${item.score}</td>
                        <td data-label="ç¸½å‡ºç¾æ¬¡æ•¸">${item.frequency}</td>
                        <td data-label="åŠ æ¬Šé »ç‡">${item.weightedFrequency}</td>
                        <td data-label="é–“éš”åˆ†æ•¸">${item.gapScore}</td>
                        <td data-label="æ¨¡å¼åˆ†æ•¸">${item.patternScore}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š åˆ†ææ–¹æ³•èªªæ˜</h3>
                    <p style="color: #666; line-height: 1.8; margin-bottom: 10px;">
                        <strong>ç¶œåˆåˆ†æ•¸è¨ˆç®—æ–¹å¼:</strong>
                    </p>
                    <ul style="color: #666; line-height: 1.8; margin-left: 20px;">
                        <li><strong>é »ç‡åˆ†æ (30%):</strong> çµ±è¨ˆæ¯å€‹è™Ÿç¢¼åœ¨æ­·å²è³‡æ–™ä¸­çš„ç¸½å‡ºç¾æ¬¡æ•¸</li>
                        <li><strong>åŠ æ¬Šé »ç‡ (35%):</strong> è¿‘æœŸå‡ºç¾çš„è™Ÿç¢¼çµ¦äºˆæ›´é«˜æ¬Šé‡ï¼Œåæ˜ è¶¨å‹¢è®ŠåŒ–</li>
                        <li><strong>é–“éš”åˆ†æ (20%):</strong> åˆ†æè™Ÿç¢¼å¤šä¹…æ²’å‡ºç¾ï¼Œé–“éš”è¶Šé•·è¡¨ç¤ºå¯èƒ½"è©²å‡ºç¾äº†"</li>
                        <li><strong>æ¨¡å¼åˆ†æ (15%):</strong> åˆ†ææœ€è¿‘å¹¾æœŸçš„å‡ºç¾æ¨¡å¼ï¼Œæ•æ‰çŸ­æœŸè¶¨å‹¢</li>
                    </ul>
                    <p style="color: #999; font-size: 12px; margin-top: 15px; font-style: italic;">
                        âš ï¸ æ³¨æ„ï¼šæ­¤åˆ†æåƒ…ä¾›åƒè€ƒï¼Œå½©ç¥¨çµæœå…·æœ‰éš¨æ©Ÿæ€§ï¼Œç„¡æ³•ä¿è­‰é æ¸¬æº–ç¢ºæ€§ã€‚
                    </p>
                </div>
            `;

            container.innerHTML = html;
        }

        async function showValidation() {
            const validateButton = document.getElementById('validateButton');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const loadingText = document.getElementById('loadingText');

            if (currentResults.length === 0) {
                error.textContent = 'éŒ¯èª¤: è«‹å…ˆå–å¾—æ”ªç çµæœ';
                error.style.display = 'block';
                return;
            }

            // é‡ç½®ç‹€æ…‹
            validateButton.disabled = true;
            error.style.display = 'none';
            loading.style.display = 'flex';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            loadingText.textContent = 'æ­£åœ¨é€²è¡Œè¿­ä»£é©—è­‰...ï¼ˆé€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“ï¼‰';
            progressText.textContent = '';

            let eventSource = null;
            let validationResult = null;

            try {
                // ä½¿ç”¨ EventSource æ¥æ”¶ SSE äº‹ä»¶
                // æ³¨æ„ï¼šEventSource åªæ”¯æŒ GET è«‹æ±‚ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦ä½¿ç”¨ POST ä¸¦é€šéå…¶ä»–æ–¹å¼
                // æ”¹ç”¨ fetch é…åˆ ReadableStream
                const response = await fetch('/api/lottery/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults,
                        lookbackPeriods: 100
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let hasReceivedData = false;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine === '') continue; // è·³éç©ºè¡Œ
                        
                        if (trimmedLine.startsWith('data: ')) {
                            try {
                                const jsonStr = trimmedLine.substring(6).trim();
                                if (!jsonStr) {
                                    continue; // è·³éç©ºçš„æ•¸æ“šè¡Œ
                                }
                                
                                const data = JSON.parse(jsonStr);
                                hasReceivedData = true;
                                
                                if (data.type === 'start') {
                                    loadingText.textContent = data.message || 'é–‹å§‹è¿­ä»£é©—è­‰...';
                                    progressBar.style.width = '1%';
                                } else if (data.type === 'progress' || data.progress !== undefined) {
                                    // è™•ç†é€²åº¦æ›´æ–°
                                    const progress = Math.min(100, Math.max(0, data.progress || 0));
                                    progressBar.style.width = progress + '%';
                                    
                                    if (data.stage === 'weightTesting') {
                                        progressText.textContent = `æ¸¬è©¦æ¬Šé‡é…ç½® ${data.weightSetIndex || 0}/${data.totalWeightSets || 0} (${progress}%)`;
                                        loadingText.textContent = 'æ­£åœ¨æ¸¬è©¦åˆå§‹æ¬Šé‡é…ç½®...';
                                    } else if (data.stage === 'retrying') {
                                        progressText.textContent = data.message || `é‡è©¦ ${data.retryCount || 0}/${data.maxRetries || 0}`;
                                        loadingText.textContent = `é‡è©¦ ${data.retryCount || 0}/${data.maxRetries || 0} - å¹³å‡å‘½ä¸­æ•¸: ${data.averageHitCount || 0}`;
                                    } else if (data.stage === 'validationComplete' || data.stage === 'generatingPrediction') {
                                        progressText.textContent = data.message || 'æ­£åœ¨è™•ç†...';
                                        loadingText.textContent = data.message || 'æ­£åœ¨è™•ç†...';
                                    } else if (data.stage === 'validating') {
                                        const message = data.message || `è¿­ä»£é©—è­‰é€²åº¦: ${data.processedPeriods || 0}/${data.totalPeriods || 0} (${progress}%)`;
                                        progressText.textContent = message;
                                        if (data.retryCount && data.maxRetries) {
                                            loadingText.textContent = `é‡è©¦ ${data.retryCount}/${data.maxRetries} - æ­£åœ¨é©—è­‰æœŸæ•¸...`;
                                        } else {
                                            loadingText.textContent = 'æ­£åœ¨é€²è¡Œè¿­ä»£é©—è­‰...';
                                        }
                                    } else {
                                        const message = data.message || `è¿­ä»£é©—è­‰é€²åº¦: ${data.processedPeriods || 0}/${data.totalPeriods || 0} (${progress}%)`;
                                        progressText.textContent = message;
                                        if (data.retryCount && data.maxRetries) {
                                            loadingText.textContent = `é‡è©¦ ${data.retryCount}/${data.maxRetries} - æ­£åœ¨é©—è­‰æœŸæ•¸...`;
                                        } else {
                                            loadingText.textContent = 'æ­£åœ¨é€²è¡Œè¿­ä»£é©—è­‰...';
                                        }
                                    }
                                } else if (data.type === 'complete') {
                                    loadingText.textContent = data.message || 'è¿­ä»£é©—è­‰å®Œæˆ';
                                    progressBar.style.width = '100%';
                                    progressText.textContent = 'é©—è­‰å®Œæˆï¼Œæ­£åœ¨è™•ç†çµæœ...';
                                } else if (data.type === 'result') {
                                    validationResult = data.data;
                                } else if (data.type === 'error') {
                                    throw new Error(data.message || data.error || 'è¿­ä»£é©—è­‰å¤±æ•—');
                                }
                            } catch (parseErr) {
                                console.error('è§£æé€²åº¦æ•¸æ“šå¤±æ•—:', parseErr, 'åŸå§‹è¡Œ:', trimmedLine);
                            }
                        }
                    }
                }

                if (validationResult) {
                    displayValidationResults(validationResult);
                } else {
                    throw new Error('æœªæ”¶åˆ°é©—è­‰çµæœ');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
                console.error('è¿­ä»£é©—è­‰éŒ¯èª¤:', err);
            } finally {
                validateButton.disabled = false;
                loading.style.display = 'none';
                progressContainer.style.display = 'none';
                if (eventSource) {
                    eventSource.close();
                }
            }
        }

        // å„²å­˜é©—è­‰å¾Œçš„æœ€çµ‚æ¬Šé‡ï¼ˆå¦‚æœé€²è¡Œäº†è¿­ä»£é©—è­‰ï¼‰
        let optimizedWeights = null;

        function displayValidationResults(validationData) {
            // ä¿å­˜å„ªåŒ–å¾Œçš„æ¬Šé‡ç”¨æ–¼é æ¸¬
            optimizedWeights = validationData.finalWeights;

            const container = document.getElementById('resultsContainer');

            let html = '';

            // é¦–å…ˆé¡¯ç¤ºæœ€çµ‚é æ¸¬è™Ÿç¢¼ï¼ˆæœ€çªå‡ºï¼‰
            if (validationData.latestPeriodPrediction) {
                html += `
                <div style="margin-bottom: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                    <div style="position: relative; z-index: 1;">
                        <h2 style="color: white; margin-bottom: 10px; font-size: 2.2em; text-align: center; text-shadow: 3px 3px 6px rgba(0,0,0,0.4);">
                            ğŸ¯ æœ€çµ‚é æ¸¬æœªä¾†ä¸€æœŸè™Ÿç¢¼
                        </h2>
                        <p style="color: rgba(255, 255, 255, 0.95); font-size: 16px; text-align: center; margin-bottom: 25px; font-weight: 500;">
                            åŸºæ–¼è¿­ä»£é©—è­‰èˆ‡æ”ªå‡ºç†è«–åˆ†æ | æœŸæ•¸ ${validationData.latestPeriodPrediction.periodNumber} çš„ä¸‹ä¸€æœŸé æ¸¬
                        </p>
                        <div style="background: rgba(255, 255, 255, 0.98); padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);">
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 25px 0; align-items: center;">`;

                // é¡¯ç¤ºé æ¸¬çš„6å€‹è™Ÿç¢¼ï¼ˆæ›´å¤§æ›´çªå‡ºï¼‰
                validationData.latestPeriodPrediction.predictedNumbers.forEach((num, index) => {
                    html += `
                        <div style="
                            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                            color: white;
                            padding: 20px 25px;
                            border-radius: 50%;
                            font-weight: bold;
                            font-size: 32px;
                            width: 80px;
                            height: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
                            border: 3px solid rgba(255, 255, 255, 0.8);
                            transition: transform 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">${num}</div>`;
                });

                html += `
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">
                                <p style="color: #333; font-size: 14px; margin-bottom: 12px; font-weight: 600;">ğŸ“Š é æ¸¬è©³æƒ…ï¼š</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                    <div style="background: white; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 12px; color: #666;">ä½¿ç”¨ç­–ç•¥</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">${validationData.latestPeriodPrediction.strategy}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 12px; color: #666;">åˆ†ææœŸæ•¸</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">${validationData.latestPeriodPrediction.analysis.totalPeriods} æœŸ</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 12px; color: #666;">é æ¸¬è™Ÿç¢¼æ•¸</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">${validationData.latestPeriodPrediction.predictedNumbers.length} å€‹</div>
                                    </div>
                                </div>
                                <p style="color: #666; font-size: 13px; margin-top: 15px; line-height: 1.6;">
                                    <strong>é æ¸¬æ–¹æ³•èªªæ˜ï¼š</strong>æ­¤é æ¸¬åŸºæ–¼è¿­ä»£é©—è­‰éç¨‹ï¼Œä½¿ç”¨å¤šç¨®çµ±è¨ˆç†è«–ï¼ˆé »ç‡åˆ†æã€åŠ æ¬Šé »ç‡ã€é–“éš”åˆ†æã€æ¨¡å¼åˆ†æã€åˆ†å¸ƒåˆ†æã€è¶¨å‹¢åˆ†æã€å¡æ–¹æª¢é©—ã€æ³Šæ¾åˆ†å¸ƒã€æ–æ³¢é‚£å¥‘åˆ†æã€ç›¸é—œæ€§åˆ†æã€ç†µåˆ†æã€é¦¬å¯å¤«éˆã€çµ„åˆæ•¸å­¸ï¼‰é€²è¡Œç¶œåˆåˆ†æï¼Œä¸¦é€šéæ­·å²æ•¸æ“šé©—è­‰å„ªåŒ–æ¬Šé‡ï¼Œæœ€çµ‚é¸å‡ºæœ€æœ‰å¯èƒ½åœ¨ä¸‹ä¸€æœŸè¢«æ”ªå‡ºçš„6å€‹è™Ÿç¢¼ã€‚
                                </p>
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #e8f4f8; border-radius: 10px;">
                                <p style="color: #333; font-size: 14px; margin-bottom: 10px; font-weight: 600;">å‰10åå€™é¸è™Ÿç¢¼ï¼ˆæŒ‰ç¶œåˆåˆ†æ•¸æ’åºï¼‰ï¼š</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">`;

                // é¡¯ç¤ºå‰10åå€™é¸è™Ÿç¢¼
                validationData.latestPeriodPrediction.topNumbers.forEach((item, index) => {
                    const isPredicted = validationData.latestPeriodPrediction.predictedNumbers.includes(item.number);
                    html += `
                        <span class="number-badge" style="
                            background: ${isPredicted ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
                            color: white;
                            padding: 10px 15px;
                            border-radius: 25px;
                            font-weight: 600;
                            font-size: 15px;
                            ${isPredicted ? 'border: 3px solid #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.3); transform: scale(1.05);' : ''}
                        ">${item.number}${isPredicted ? ' âœ“' : ''} <span style="font-size: 12px; opacity: 0.95;">(${Math.round(item.score * 100) / 100})</span></span>`;
                });

                html += `
                                </div>
                                <p style="color: #999; font-size: 12px; margin-top: 12px; font-style: italic;">
                                    âœ“ æ¨™è¨˜ç‚ºæœ€çµ‚é æ¸¬è™Ÿç¢¼ï¼ˆå·²é¸ä¸­çš„6å€‹è™Ÿç¢¼ï¼‰
                                </p>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            html += `
                <div class="stats">
                    <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ”„ è¿­ä»£é©—è­‰çµæœ</h2>
                    <p><strong>æœ€æ–°æœŸæ•¸:</strong> ${validationData.latestPeriod}</p>
                    <p><strong>é–‹å§‹æœŸæ•¸:</strong> ${validationData.startPeriod}</p>
                    <p><strong>é©—è­‰æ¬¡æ•¸:</strong> ${validationData.totalValidations} æ¬¡</p>
                </div>
                
                <div style="margin-top: 30px; background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š ç¸½é«”çµ±è¨ˆ</h3>
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç¸½å‘½ä¸­æ•¸</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${validationData.statistics.totalHits}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡æ¯æœŸå‘½ä¸­æ•¸</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${validationData.statistics.meetsHitCountTarget ? '#28a745' : '#dc3545'};">
                                ${Math.round(validationData.statistics.averageHitsPerPeriod * 100) / 100}
                                <span style="font-size: 12px; color: #666;">/ ${validationData.statistics.targetAverageHitCount}</span>
                            </div>
                            ${validationData.statistics.meetsHitCountTarget ?
                    '<div style="font-size: 11px; color: #28a745; margin-top: 5px;">âœ“ é”æ¨™</div>' :
                    `<div style="font-size: 11px; color: #dc3545; margin-top: 5px;">âœ— ${validationData.statistics.targetSummary?.averageHitCount?.status || 'æœªé”æ¨™'}</div>`
                }
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡æº–ç¢ºç‡</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${validationData.statistics.meetsAccuracyTarget ? '#28a745' : '#dc3545'};">
                                ${validationData.statistics.averageAccuracy}%
                                <span style="font-size: 12px; color: #666;">/ ${validationData.statistics.targetAverageAccuracy}%</span>
                            </div>
                            ${validationData.statistics.meetsAccuracyTarget ?
                    '<div style="font-size: 11px; color: #28a745; margin-top: 5px;">âœ“ é”æ¨™</div>' :
                    `<div style="font-size: 11px; color: #dc3545; margin-top: 5px;">âœ— ${validationData.statistics.targetSummary?.averageAccuracy?.status || 'æœªé”æ¨™'}</div>`
                }
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡è¦†è“‹ç‡</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${validationData.statistics.averageCoverage}%</div>
                        </div>
                    </div>
                    ${validationData.statistics.targetSummary ? `
                    <div style="margin-top: 20px; padding: 15px; background: ${validationData.statistics.meetsAllTargets ? '#d4edda' : '#f8d7da'}; border-radius: 8px; border-left: 4px solid ${validationData.statistics.meetsAllTargets ? '#28a745' : '#dc3545'};">
                        <h4 style="color: ${validationData.statistics.meetsAllTargets ? '#155724' : '#721c24'}; margin-bottom: 10px;">
                            ${validationData.statistics.meetsAllTargets ? 'âœ“ æ‰€æœ‰ç›®æ¨™å·²é”æˆ' : 'âœ— éƒ¨åˆ†ç›®æ¨™æœªé”æˆ'}
                        </h4>
                        <div style="font-size: 14px; color: ${validationData.statistics.meetsAllTargets ? '#155724' : '#721c24'};">
                            <p><strong>å¹³å‡å‘½ä¸­æ•¸:</strong> ${validationData.statistics.targetSummary.averageHitCount.current} / ${validationData.statistics.targetSummary.averageHitCount.target} 
                            ${validationData.statistics.targetSummary.averageHitCount.meetsTarget ? 'âœ“' : `(${validationData.statistics.targetSummary.averageHitCount.status})`}</p>
                            <p><strong>å¹³å‡æº–ç¢ºç‡:</strong> ${validationData.statistics.targetSummary.averageAccuracy.current}% / ${validationData.statistics.targetSummary.averageAccuracy.target}% 
                            ${validationData.statistics.targetSummary.averageAccuracy.meetsTarget ? 'âœ“' : `(${validationData.statistics.targetSummary.averageAccuracy.status})`}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                
                <div style="margin-top: 30px; background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #333; margin-bottom: 15px;">âš™ï¸ æœ€çµ‚èª¿æ•´å¾Œçš„æ¬Šé‡</h3>
                    <div class="weight-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">é »ç‡</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.frequency * 100)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">åŠ æ¬Šé »ç‡</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.weightedFrequency * 100)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">é–“éš”</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.gap * 100)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">æ¨¡å¼</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.pattern * 100)}%</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">ğŸ“‹ è©³ç´°é©—è­‰è¨˜éŒ„</h3>
                    <div class="table-wrapper">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>è¨“ç·´æœŸæ•¸</th>
                                    <th>ç›®æ¨™æœŸæ•¸</th>
                                    <th>é æ¸¬è™Ÿç¢¼</th>
                                    <th>å¯¦éš›è™Ÿç¢¼</th>
                                    <th>å‘½ä¸­æ•¸</th>
                                    <th>æº–ç¢ºç‡</th>
                                    <th>è¦†è“‹ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // ä½¿ç”¨å…±äº«çš„æœŸæ•¸è§£æå‡½æ•¸ï¼ˆç”¨æ–¼æ’åºï¼Œéœ€è¦è½‰æ›å¹´ä»½ï¼‰
            const parsePeriodForSort = (periodNumber) => {
                return parsePeriodNumber(periodNumber, { convertYear: true });
            };

            // æ¯”è¼ƒå…©å€‹æœŸæ•¸ï¼Œç”¨æ–¼æ’åºï¼ˆæ–°è‡³èˆŠï¼šè¼ƒæ–°çš„æœŸæ•¸æ’åœ¨å‰é¢ï¼‰
            const comparePeriods = (a, b) => {
                const periodA = parsePeriodForSort(a.targetPeriod);
                const periodB = parsePeriodForSort(b.targetPeriod);

                // å…ˆæ¯”è¼ƒå¹´ä»½ï¼Œå¹´ä»½å¤§çš„ï¼ˆæ–°çš„ï¼‰æ’åœ¨å‰é¢
                if (periodA.year !== periodB.year) {
                    return periodB.year - periodA.year;
                }

                // å¹´ä»½ç›¸åŒï¼Œæ¯”è¼ƒæœŸæ•¸ï¼ŒæœŸæ•¸å¤§çš„ï¼ˆæ–°çš„ï¼‰æ’åœ¨å‰é¢
                return periodB.period - periodA.period;
            };

            // è¨ˆç®—ä¸‹ä¸€æœŸæœŸæ•¸ï¼ˆç”¨æ–¼æœ€çµ‚é æ¸¬ï¼‰
            const parsePeriod = (periodStr) => {
                return parsePeriodNumber(periodStr, { convertYear: false, returnNull: true });
            };

            const latestPeriodParsed = parsePeriod(validationData.latestPeriod);
            let nextPeriodStr = 'ä¸‹ä¸€æœŸ';
            if (latestPeriodParsed) {
                const nextPeriod = latestPeriodParsed.period + 1;
                // çµ±ä¸€ä½¿ç”¨ 00/000 æ ¼å¼é¡¯ç¤ºç›®æ¨™æœŸæ•¸
                // å¾å¹´ä»½ä¸­æå–2ä½æ•¸å¹´ä»½ï¼ˆå¦‚æœæ˜¯4ä½æ•¸å¹´ä»½ï¼Œå–å¾Œ2ä½ï¼›å¦‚æœæ˜¯2ä½æ•¸å¹´ä»½ï¼Œç›´æ¥ä½¿ç”¨ï¼‰
                let year2Digit = latestPeriodParsed.year;
                if (year2Digit >= 1000) {
                    year2Digit = year2Digit % 100; // å–å¾Œ2ä½
                }
                // æ ¼å¼ï¼šYY/PPPï¼ˆä¾‹å¦‚ï¼š25/001ï¼‰
                nextPeriodStr = `${String(year2Digit).padStart(2, '0')}/${String(nextPeriod).padStart(3, '0')}`;
            }

            // ç²å–æœ€çµ‚é æ¸¬è™Ÿç¢¼ï¼ˆå¦‚æœæœ‰ latestPeriodPredictionï¼Œä½¿ç”¨å®ƒï¼›å¦å‰‡å˜—è©¦å¾é©—è­‰çµæœä¸­ç²å–ï¼‰
            let finalPredictedNumbers = [];
            if (validationData.latestPeriodPrediction && validationData.latestPeriodPrediction.predictedNumbers) {
                // ç¢ºä¿è™Ÿç¢¼ç”±å°åˆ°å¤§æ’åº
                finalPredictedNumbers = [...validationData.latestPeriodPrediction.predictedNumbers].sort((a, b) => a - b);
            } else {
                // å¦‚æœæ²’æœ‰ latestPeriodPredictionï¼Œå˜—è©¦å¾æœ€æ–°çš„é©—è­‰çµæœä¸­ç²å–é æ¸¬è™Ÿç¢¼
                // é€™é€šå¸¸ä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºå¾Œç«¯æ‡‰è©²å·²ç¶“è¨ˆç®—äº† latestPeriodPrediction
                console.warn('æœªæ‰¾åˆ° latestPeriodPredictionï¼Œå°‡é¡¯ç¤ºç©ºé æ¸¬');
            }

            // åœ¨è¡¨æ ¼é–‹é ­åŠ å…¥æœ€çµ‚é æ¸¬è¡Œï¼ˆä½¿ç”¨æœ€æ–°æœŸæ•¸ä½œç‚ºè¨“ç·´æœŸæ•¸ï¼‰
            if (finalPredictedNumbers.length > 0) {
                const finalPredictedNumbersHtml = finalPredictedNumbers.map(num =>
                    `<span class="number-badge" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: 2px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-weight: bold; font-size: 14px;">${num}</span>`
                ).join('');

                html += `
                    <tr style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%); border-top: 3px solid #667eea; border-bottom: 2px solid #667eea;">
                        <td data-label="è¨“ç·´æœŸæ•¸"><strong style="color: #667eea; font-size: 1.1em;">${validationData.latestPeriod}</strong> <span style="color: #f093fb; font-size: 0.9em;" title="ä½¿ç”¨æœ€æ–°æœŸæ•¸ä½œç‚ºè¨“ç·´æœŸæ•¸">â­</span></td>
                        <td data-label="ç›®æ¨™æœŸæ•¸"><strong style="color: #667eea; font-size: 1.1em;">${nextPeriodStr}</strong></td>
                        <td data-label="é æ¸¬è™Ÿç¢¼">${finalPredictedNumbersHtml || 'ç„¡'}</td>
                        <td data-label="å¯¦éš›è™Ÿç¢¼"><span style="color: #999; font-style: italic;">å¾…é–‹ç</span></td>
                        <td data-label="å‘½ä¸­æ•¸"><span style="color: #999; font-style: italic;">-</span></td>
                        <td data-label="æº–ç¢ºç‡"><span style="color: #999; font-style: italic;">-</span></td>
                        <td data-label="è¦†è“‹ç‡"><span style="color: #999; font-style: italic;">-</span></td>
                    </tr>
                `;
            } else {
                // å¦‚æœæ²’æœ‰é æ¸¬è™Ÿç¢¼ï¼Œä»ç„¶é¡¯ç¤ºä¸€è¡Œæç¤º
                html += `
                    <tr style="background: rgba(255, 193, 7, 0.1); border-top: 2px solid #ffc107;">
                        <td data-label="è¨“ç·´æœŸæ•¸"><strong style="color: #667eea;">${validationData.latestPeriod}</strong></td>
                        <td data-label="ç›®æ¨™æœŸæ•¸"><strong style="color: #667eea;">${nextPeriodStr}</strong></td>
                        <td data-label="é æ¸¬è™Ÿç¢¼" colspan="5"><span style="color: #999; font-style: italic;">é æ¸¬è¨ˆç®—ä¸­...</span></td>
                    </tr>
                `;
            }

            // å°é©—è­‰çµæœé€²è¡Œæ’åºï¼ˆæŒ‰ç›®æ¨™æœŸæ•¸æ–°è‡³èˆŠæ’åºï¼Œä¸æ”¹è®Šè¨ˆç®—ï¼Œåªæ”¹è®Šé¡¯ç¤ºï¼‰
            const sortedResults = [...validationData.validationResults].sort(comparePeriods);

            sortedResults.forEach((result, index) => {
                const hitCount = result.comparison.hitCount;
                const accuracy = result.comparison.accuracy;
                const coverage = result.comparison.coverage;

                // å‘½ä¸­æ•¸çš„é¡è‰²æ¨™è¨˜
                const hitColor = hitCount >= 3 ? '#28a745' : hitCount >= 1 ? '#ffc107' : '#dc3545';

                // ç²å–å¯¦éš›è™Ÿç¢¼çš„æœ€å¾Œä¸€å€‹è™Ÿç¢¼ï¼ˆç¢ºä¿é¡å‹ä¸€è‡´ï¼‰
                const lastActualNumber = result.actualNumbers && result.actualNumbers.length > 0
                    ? Number(result.actualNumbers[result.actualNumbers.length - 1])
                    : null;

                // æ ¼å¼åŒ–è™Ÿç¢¼é¡¯ç¤ºï¼ˆç¢ºä¿è™Ÿç¢¼ç”±å°åˆ°å¤§æ’åºï¼‰
                const sortedPredictedNumbers = [...result.predictedNumbers].sort((a, b) => a - b);
                const predictedNumbers = sortedPredictedNumbers.map(num => {
                    const numValue = Number(num);
                    let bgStyle = '';

                    // å„ªå…ˆæª¢æŸ¥ï¼šå¦‚æœè™Ÿç¢¼æ˜¯å¯¦éš›è™Ÿç¢¼çš„æœ€å¾Œä¸€å€‹è™Ÿç¢¼ï¼Œé¡¯ç¤ºä¸€åŠç¶ è‰²ä¸€åŠè—è‰²
                    if (lastActualNumber !== null && numValue === lastActualNumber) {
                        // ä½¿ç”¨æ›´æ˜ç¢ºçš„æ¼¸è®Šèªæ³•ï¼Œç¢ºä¿å·¦å³å„ä¸€åŠ
                        bgStyle = 'background: linear-gradient(90deg, #28a745 0%, #28a745 49.9%, #667eea 50.1%, #667eea 100%) !important;';
                    }
                    // å¦‚æœè™Ÿç¢¼åœ¨å‘½ä¸­åˆ—è¡¨ä¸­ï¼Œé¡¯ç¤ºç¶ è‰²
                    else if (result.comparison.hits && result.comparison.hits.some(hit => Number(hit) === numValue)) {
                        bgStyle = 'background: #28a745 !important;';
                    }
                    // å…¶ä»–æƒ…æ³é¡¯ç¤ºè—è‰²
                    else {
                        bgStyle = 'background: #667eea !important;';
                    }

                    return `<span class="number-badge" style="${bgStyle}">${num}</span>`;
                }).join('');

                const actualNumbers = result.actualNumbers.map(num =>
                    `<span class="number-badge">${num}</span>`
                ).join('');

                html += `
                    <tr>
                        <td data-label="è¨“ç·´æœŸæ•¸"><strong>${result.trainingPeriod}</strong></td>
                        <td data-label="ç›®æ¨™æœŸæ•¸"><strong>${result.targetPeriod}</strong></td>
                        <td data-label="é æ¸¬è™Ÿç¢¼">${predictedNumbers || 'ç„¡'}</td>
                        <td data-label="å¯¦éš›è™Ÿç¢¼">${actualNumbers || 'ç„¡'}</td>
                        <td data-label="å‘½ä¸­æ•¸" style="color: ${hitColor}; font-weight: bold; font-size: 18px;">${hitCount}</td>
                        <td data-label="æº–ç¢ºç‡">${Math.round(accuracy * 100) / 100}%</td>
                        <td data-label="è¦†è“‹ç‡">${Math.round(coverage * 100) / 100}%</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“– é©—è­‰èªªæ˜</h3>
                    <ul style="color: #666; line-height: 1.8; margin-left: 20px;">
                        <li><strong>è¨“ç·´æœŸæ•¸:</strong> ç”¨æ–¼åˆ†æçš„æ­·å²è³‡æ–™æˆªæ­¢æœŸæ•¸</li>
                        <li><strong>ç›®æ¨™æœŸæ•¸:</strong> è¦é æ¸¬çš„æœŸæ•¸</li>
                        <li><strong>å‘½ä¸­æ•¸:</strong> é æ¸¬è™Ÿç¢¼ä¸­å¯¦éš›é–‹å‡ºçš„è™Ÿç¢¼æ•¸é‡</li>
                        <li><strong>æº–ç¢ºç‡:</strong> å‘½ä¸­æ•¸ / é æ¸¬è™Ÿç¢¼ç¸½æ•¸ Ã— 100%</li>
                        <li><strong>è¦†è“‹ç‡:</strong> å‘½ä¸­æ•¸ / å¯¦éš›é–‹å‡ºè™Ÿç¢¼ç¸½æ•¸ Ã— 100%</li>
                        <li><strong>æ¬Šé‡èª¿æ•´:</strong> ç³»çµ±æœƒæ ¹æ“šæ¯æœŸçš„é©—è­‰çµæœè‡ªå‹•èª¿æ•´åˆ†ææ¬Šé‡ï¼Œä»¥å„ªåŒ–é æ¸¬æ•ˆæœ</li>
                    </ul>
                    <p style="color: #999; font-size: 12px; margin-top: 15px; font-style: italic;">
                        ğŸ’¡ æç¤ºï¼šç¶ è‰²æ¨™è¨˜çš„é æ¸¬è™Ÿç¢¼è¡¨ç¤ºæˆåŠŸå‘½ä¸­ï¼Œç´«è‰²è¡¨ç¤ºæœªå‘½ä¸­ã€‚
                    </p>
                </div>
            `;

            container.innerHTML = html;
        }

        async function showLatestPrediction() {
            const predictButton = document.getElementById('predictButton');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');

            if (currentResults.length === 0) {
                error.textContent = 'éŒ¯èª¤: è«‹å…ˆå–å¾—æ”ªç çµæœ';
                error.style.display = 'block';
                return;
            }

            // é‡ç½®ç‹€æ…‹
            predictButton.disabled = true;
            error.style.display = 'none';
            loading.style.display = 'flex';
            document.getElementById('loadingText').textContent = 'æ­£åœ¨åˆ†æä¸¦é æ¸¬ä¸‹ä¸€æœŸè™Ÿç¢¼...';

            try {
                // ä½¿ç”¨æ‰€æœ‰æ­·å²æ•¸æ“šé€²è¡Œé æ¸¬
                const response = await fetch('/api/lottery/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults,
                        weights: optimizedWeights // å¦‚æœé€²è¡Œäº†è¿­ä»£é©—è­‰ï¼Œä½¿ç”¨å„ªåŒ–å¾Œçš„æ¬Šé‡
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayLatestPrediction(data.data, currentResults[0]);
                } else {
                    throw new Error(data.message || 'é æ¸¬å¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                predictButton.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayLatestPrediction(analysisData, latestResult) {
            const container = document.getElementById('resultsContainer');

            // ç²å–æœ€æ–°æœŸæ•¸
            const latestPeriod = latestResult.periodNumber;

            // ä½¿ç”¨å…±äº«çš„æœŸæ•¸è§£æå‡½æ•¸ï¼ˆç”¨æ–¼è¨ˆç®—ä¸‹ä¸€æœŸï¼Œä¸éœ€è¦è½‰æ›å¹´ä»½ï¼Œå¤±æ•—æ™‚è¿”å›nullï¼‰
            const parsePeriod = (periodStr) => {
                return parsePeriodNumber(periodStr, { convertYear: false, returnNull: true });
            };

            const currentPeriod = parsePeriod(latestPeriod);
            let nextPeriodStr = 'ä¸‹ä¸€æœŸ';
            if (currentPeriod) {
                const nextPeriod = currentPeriod.period + 1;
                if (latestPeriod.includes('/')) {
                    nextPeriodStr = `${currentPeriod.year}/${nextPeriod}`;
                } else {
                    nextPeriodStr = `${currentPeriod.year}${String(nextPeriod).padStart(3, '0')}`;
                }
            }

            let html = '';

            // é¦–å…ˆé¡¯ç¤ºæœ€çµ‚é æ¸¬çš„6å€‹è™Ÿç¢¼ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (analysisData.predictedNumbers && analysisData.predictedNumbers.length > 0) {
                html += `
                <div style="margin-bottom: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
                    <div style="position: relative; z-index: 1;">
                        <h2 style="color: white; margin-bottom: 10px; font-size: 2.2em; text-align: center; text-shadow: 3px 3px 6px rgba(0,0,0,0.4);">
                            ğŸ¯ æœ€çµ‚é æ¸¬æœªä¾†ä¸€æœŸè™Ÿç¢¼
                        </h2>
                        <p style="color: rgba(255, 255, 255, 0.95); font-size: 16px; text-align: center; margin-bottom: 25px; font-weight: 500;">
                            åŸºæ–¼ ${analysisData.stats.totalPeriods} æœŸæ­·å²æ•¸æ“šåˆ†æ | é æ¸¬æœŸæ•¸: <strong>${nextPeriodStr}</strong>
                        </p>
                        <div style="background: rgba(255, 255, 255, 0.98); padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);">
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 25px 0; align-items: center;">`;

                // é¡¯ç¤ºé æ¸¬çš„6å€‹è™Ÿç¢¼
                analysisData.predictedNumbers.forEach((num, index) => {
                    html += `
                        <div style="
                            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                            color: white;
                            padding: 20px 25px;
                            border-radius: 50%;
                            font-weight: bold;
                            font-size: 32px;
                            width: 80px;
                            height: 80px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
                            border: 3px solid rgba(255, 255, 255, 0.8);
                            transition: transform 0.3s ease;
                        " onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">${num}</div>`;
                });

                html += `
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea;">
                                <p style="color: #333; font-size: 14px; margin-bottom: 12px; font-weight: 600;">ğŸ“Š é æ¸¬è©³æƒ…ï¼š</p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 15px;">
                                    <div style="background: white; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 12px; color: #666;">ä½¿ç”¨ç­–ç•¥</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">${analysisData.predictionStrategy || 'optimal'}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 12px; color: #666;">åˆ†ææœŸæ•¸</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">${analysisData.stats.totalPeriods} æœŸ</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 8px;">
                                        <div style="font-size: 12px; color: #666;">é æ¸¬è™Ÿç¢¼æ•¸</div>
                                        <div style="font-size: 16px; font-weight: bold; color: #667eea;">${analysisData.predictedNumbers.length} å€‹</div>
                                    </div>
                                </div>
                                <p style="color: #666; font-size: 13px; margin-top: 15px; line-height: 1.6;">
                                    <strong>é æ¸¬æ–¹æ³•èªªæ˜ï¼š</strong>æ­¤é æ¸¬ä½¿ç”¨å¤šç¨®çµ±è¨ˆç†è«–ï¼ˆé »ç‡åˆ†æã€åŠ æ¬Šé »ç‡ã€é–“éš”åˆ†æã€æ¨¡å¼åˆ†æã€åˆ†å¸ƒåˆ†æã€è¶¨å‹¢åˆ†æã€å¡æ–¹æª¢é©—ã€æ³Šæ¾åˆ†å¸ƒã€æ–æ³¢é‚£å¥‘åˆ†æã€ç›¸é—œæ€§åˆ†æã€ç†µåˆ†æã€é¦¬å¯å¤«éˆã€çµ„åˆæ•¸å­¸ï¼‰é€²è¡Œç¶œåˆåˆ†æï¼Œä¸¦é€šéæ™ºèƒ½é¸æ“‡ç­–ç•¥é¸å‡ºæœ€æœ‰å¯èƒ½åœ¨ä¸‹ä¸€æœŸè¢«æ”ªå‡ºçš„6å€‹è™Ÿç¢¼ã€‚
                                    ${optimizedWeights ? '<br><br><span style="color: #28a745; font-weight: 600;">âœ“ å·²ä½¿ç”¨è¿­ä»£é©—è­‰å„ªåŒ–å¾Œçš„æ¬Šé‡åƒæ•¸</span>' : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>`;
            }

            html += `
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; color: white; text-align: center; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);">
                    <h2 style="margin: 0 0 10px 0; font-size: 1.8em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ¯ æœ€æ–°é æ¸¬</h2>
                    <p style="margin: 0; font-size: 1.1em; opacity: 0.95;">åŸºæ–¼ ${analysisData.stats.totalPeriods} æœŸæ­·å²æ•¸æ“šåˆ†æ</p>
                    <p style="margin: 15px 0 0 0; font-size: 1em; opacity: 0.9;">é æ¸¬æœŸæ•¸: <strong style="font-size: 1.2em;">${nextPeriodStr}</strong></p>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 25px; font-size: 1.8em; text-align: center;">
                        ğŸ“Š é æ¸¬æœ€æœ‰å¯èƒ½å‡ºç¾çš„ 15 å€‹è™Ÿç¢¼
                    </h3>
                    <div class="prediction-cards" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 30px;">
            `;

            // é¡¯ç¤ºå‰ 15 åè™Ÿç¢¼ï¼ˆæ ¹æ“šæœ€æ–°åˆ†æçµæœï¼‰
            analysisData.topNumbers.forEach((item, index) => {
                const rank = index + 1;
                const size = rank <= 3 ? '35px' : rank <= 5 ? '28px' : '22px';
                const isPredicted = analysisData.predictedNumbers && analysisData.predictedNumbers.includes(item.number);
                const bgColor = isPredicted ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                    rank === 1 ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                        rank === 2 ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' :
                            rank === 3 ? 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' :
                                rank <= 5 ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' :
                                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

                const borderStyle = isPredicted ? '4px solid #ffd700' : (rank <= 3 ? '3px solid #fff' : '2px solid #fff');
                const shadowStyle = isPredicted ? '0 8px 30px rgba(0, 0, 0, 0.4)' : (rank <= 3 ? '0 6px 25px rgba(0, 0, 0, 0.3)' : '0 4px 15px rgba(0, 0, 0, 0.2)');

                html += `
                    <div class="prediction-card" style="
                        background: ${bgColor};
                        color: white;
                        padding: 25px;
                        border-radius: 15px;
                        text-align: center;
                        min-width: 140px;
                        flex: 1 1 calc(50% - 8px);
                        max-width: calc(50% - 8px);
                        box-shadow: ${shadowStyle};
                        border: ${borderStyle};
                        transition: transform 0.3s ease;
                        position: relative;
                    " onmouseover="this.style.transform='scale(1.1)'; this.style.zIndex='10';" 
                       onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';">
                        ${isPredicted ? `<div style="position: absolute; top: -10px; right: -10px; background: #ffd700; color: #333; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; box-shadow: 0 3px 10px rgba(0,0,0,0.4);">âœ“</div>` : ''}
                        ${!isPredicted && rank <= 3 ? `<div style="position: absolute; top: -10px; right: -10px; background: #ffd700; color: #333; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</div>` : ''}
                        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">æ’å #${rank}${isPredicted ? ' (å·²é¸ä¸­)' : ''}</div>
                        <div style="font-size: ${size}; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${String(item.number).padStart(2, '0')}</div>
                        <div style="font-size: 12px; opacity: 0.85; margin-top: 5px;">åˆ†æ•¸: ${item.score}</div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“ˆ è©³ç´°åˆ†æ</h3>
                    <div class="table-wrapper">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>è™Ÿç¢¼</th>
                                    <th>ç¶œåˆåˆ†æ•¸</th>
                                    <th>ç¸½å‡ºç¾æ¬¡æ•¸</th>
                                    <th>åŠ æ¬Šé »ç‡</th>
                                    <th>é–“éš”åˆ†æ•¸</th>
                                    <th>æ¨¡å¼åˆ†æ•¸</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            analysisData.topNumbers.forEach((item, index) => {
                html += `
                    <tr>
                        <td data-label="æ’å"><strong>#${index + 1}</strong></td>
                        <td data-label="è™Ÿç¢¼"><span class="number-badge" style="font-size: 18px; font-weight: bold;">${String(item.number).padStart(2, '0')}</span></td>
                        <td data-label="ç¶œåˆåˆ†æ•¸"><strong>${item.score}</strong></td>
                        <td data-label="ç¸½å‡ºç¾æ¬¡æ•¸">${item.frequency}</td>
                        <td data-label="åŠ æ¬Šé »ç‡">${item.weightedFrequency}</td>
                        <td data-label="é–“éš”åˆ†æ•¸">${item.gapScore}</td>
                        <td data-label="æ¨¡å¼åˆ†æ•¸">${item.patternScore}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // æ·»åŠ è¤‡å¼æŠ•æ³¨å»ºè­°ï¼ˆå¤šå€‹é¸é …ï¼‰
            if (analysisData.compoundBetSuggestions && analysisData.compoundBetSuggestions.length > 0) {
                html += `
                <div style="margin-top: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 1.8em; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        ğŸ² è¤‡å¼æŠ•æ³¨å»ºè­°
                    </h3>
                    <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="color: #333; font-size: 16px; margin-bottom: 15px; line-height: 1.8;">
                            <strong>è¤‡å¼æŠ•æ³¨èªªæ˜ï¼š</strong>å¾7å€‹æˆ–ä»¥ä¸Šè™Ÿç¢¼ä¸­é¸å–ï¼Œç³»çµ±æœƒè‡ªå‹•çµ„åˆæ‰€æœ‰å¯èƒ½çš„6å€‹è™Ÿç¢¼çµ„åˆã€‚è™Ÿç¢¼æ•¸é‡è¶Šå¤šï¼ŒæŠ•æ³¨é‡‘é¡ä¹Ÿæœƒéš¨ä¹‹å¢åŠ ã€‚
                        </p>
                    </div>
                `;

                // é¡¯ç¤ºæ¯å€‹é¸é …
                analysisData.compoundBetSuggestions.forEach((suggestion, suggestionIndex) => {
                    const isExpanded = suggestionIndex === 0; // é è¨­å±•é–‹ç¬¬ä¸€å€‹é¸é …
                    const cardId = `compound-bet-${suggestionIndex}`;

                    html += `
                    <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <div id="header-${cardId}" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; cursor: pointer;" 
                             onclick="toggleCompoundBet('${cardId}')">
                            <div style="flex: 1;">
                                <h4 style="color: #333; margin: 0 0 5px 0; font-size: 1.3em;">${suggestion.strategy}</h4>
                                <p style="color: #666; margin: 0; font-size: 14px;">${suggestion.description}</p>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 3px;">æ³¨æ•¸</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #667eea;">${suggestion.totalBets.toLocaleString()}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 3px;">é‡‘é¡</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #f5576c;">$${suggestion.totalAmount.toLocaleString()}</div>
                                </div>
                                <div id="arrow-${cardId}" style="font-size: 24px; color: #667eea; margin-left: 10px;">${isExpanded ? 'â–¼' : 'â–¶'}</div>
                            </div>
                        </div>
                        
                        <div id="${cardId}" style="display: ${isExpanded ? 'block' : 'none'};">
                            <div style="margin-top: 15px; margin-bottom: 15px;">
                                <p style="color: #333; font-size: 14px; margin-bottom: 10px; font-weight: 600;">é¸å–çš„${suggestion.numberCount}å€‹è™Ÿç¢¼ï¼š</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    `;

                    suggestion.numbers.forEach((num, index) => {
                        html += `
                            <span class="number-badge" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 8px 15px;
                                border-radius: 20px;
                                font-weight: 600;
                                font-size: 16px;
                            ">${String(num).padStart(2, '0')}</span>
                        `;
                    });

                    html += `
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; max-height: 400px; overflow-y: auto;">
                                <p style="color: #333; font-size: 14px; margin-bottom: 10px; font-weight: 600;">
                                    æŠ•æ³¨çµ„åˆï¼ˆå…± ${suggestion.totalBets.toLocaleString()} æ³¨ï¼‰${!suggestion.isComplete ? 'ï¼ˆåƒ…é¡¯ç¤ºå‰1000æ³¨ï¼‰' : ''}ï¼š
                                </p>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                    `;

                    // é¡¯ç¤ºæŠ•æ³¨çµ„åˆï¼ˆé™åˆ¶é¡¯ç¤ºå‰100æ³¨ï¼Œé¿å…é é¢éé•·ï¼‰
                    const displayBets = suggestion.bets.slice(0, 100);
                    displayBets.forEach((bet, index) => {
                        html += `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #667eea;">
                                <div style="color: #666; font-size: 11px; margin-bottom: 5px;">ç¬¬ ${index + 1} æ³¨</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        `;
                        bet.forEach(num => {
                            html += `<span class="number-badge" style="font-size: 13px; padding: 4px 8px;">${String(num).padStart(2, '0')}</span>`;
                        });
                        html += `
                                </div>
                            </div>
                        `;
                    });

                    if (suggestion.bets.length > 100) {
                        html += `
                            <div style="grid-column: 1 / -1; text-align: center; padding: 15px; color: #666; font-style: italic;">
                                é‚„æœ‰ ${(suggestion.bets.length - 100).toLocaleString()} æ³¨æœªé¡¯ç¤º...
                            </div>
                        `;
                    }

                    html += `
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += `
                </div>
                `;
            }

            // æ·»åŠ  $100 è¤‡å¼æŠ•æ³¨å»ºè­°
            if (analysisData.compoundBetSuggestion100) {
                const suggestion100 = analysisData.compoundBetSuggestion100;
                html += `
                <div style="margin-top: 30px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 15px; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 1.8em; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        ğŸ’° $100 è¤‡å¼æŠ•æ³¨å»ºè­°
                    </h3>
                    <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="color: #333; font-size: 16px; margin-bottom: 15px; line-height: 1.8;">
                            <strong>ç­–ç•¥èªªæ˜ï¼š</strong>${suggestion100.description}
                        </p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0;">
                            <div style="background: #f8f9fa; padding: 12px 20px; border-radius: 8px; flex: 1; min-width: 150px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç¸½æ³¨æ•¸</div>
                                <div style="font-size: 24px; font-weight: bold; color: #667eea;">${suggestion100.totalBets}</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px 20px; border-radius: 8px; flex: 1; min-width: 150px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç¸½é‡‘é¡</div>
                                <div style="font-size: 24px; font-weight: bold; color: #f5576c;">$${suggestion100.totalAmount.toLocaleString()}</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <p style="color: #333; font-size: 14px; margin-bottom: 10px; font-weight: 600;">åŒ…å«çš„15å€‹è™Ÿç¢¼ï¼š</p>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                `;

                suggestion100.numbers.forEach((num, index) => {
                    const isCore = index < 8;
                    html += `
                        <span class="number-badge" style="
                            background: ${isCore ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'};
                            color: white;
                            padding: 8px 15px;
                            border-radius: 20px;
                            font-weight: 600;
                            font-size: 16px;
                        ">${String(num).padStart(2, '0')}${isCore ? ' â­' : ''}</span>
                    `;
                });

                html += `
                            </div>
                            <p style="color: #999; font-size: 12px; margin-top: 10px; font-style: italic;">
                                â­ æ¨™è¨˜ç‚ºæ ¸å¿ƒè™Ÿç¢¼ï¼ˆå‰8å€‹æœ€æœ‰å¯èƒ½çš„è™Ÿç¢¼ï¼‰
                            </p>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; max-height: 500px; overflow-y: auto;">
                        <p style="color: #333; font-size: 16px; margin-bottom: 15px; font-weight: 600;">
                            æŠ•æ³¨çµ„åˆï¼ˆå…± ${suggestion100.totalBets} æ³¨ï¼‰ï¼š
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                `;

                // é¡¯ç¤ºæ‰€æœ‰æŠ•æ³¨çµ„åˆï¼ˆ$100 å»ºè­°åªæœ‰10æ³¨ï¼Œå…¨éƒ¨é¡¯ç¤ºï¼‰
                suggestion100.bets.forEach((bet, index) => {
                    html += `
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid #f5576c;">
                            <div style="color: #666; font-size: 11px; margin-bottom: 5px;">ç¬¬ ${index + 1} æ³¨</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    `;
                    bet.forEach(num => {
                        html += `<span class="number-badge" style="font-size: 13px; padding: 4px 8px;">${String(num).padStart(2, '0')}</span>`;
                    });
                    html += `
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                </div>
                `;
            }

            html += `
                <div style="margin-top: 30px; background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ’¡ é æ¸¬èªªæ˜</h3>
                    <ul style="color: #666; line-height: 1.8; margin-left: 20px;">
                        <li>æ­¤é æ¸¬åŸºæ–¼ <strong>${analysisData.stats.totalPeriods}</strong> æœŸæ­·å²æ•¸æ“šé€²è¡Œåˆ†æ</li>
                        <li>ä½¿ç”¨å¤šç¨®çµ±è¨ˆæ–¹æ³•ç¶œåˆè©•ä¼°ï¼šé »ç‡åˆ†æã€åŠ æ¬Šé »ç‡ã€é–“éš”åˆ†æã€æ¨¡å¼åˆ†æ</li>
                        <li>è™Ÿç¢¼æŒ‰ç¶œåˆåˆ†æ•¸æ’åºï¼Œåˆ†æ•¸è¶Šé«˜è¡¨ç¤ºå‡ºç¾æ©Ÿç‡è¶Šå¤§</li>
                        ${optimizedWeights ? '<li style="color: #28a745;"><strong>âœ“ å·²ä½¿ç”¨è¿­ä»£é©—è­‰å„ªåŒ–å¾Œçš„æ¬Šé‡åƒæ•¸</strong></li>' : '<li>å»ºè­°å…ˆé€²è¡Œã€Œè¿­ä»£é©—è­‰ã€ä»¥å„ªåŒ–é æ¸¬åƒæ•¸</li>'}
                    </ul>
                    <p style="color: #999; font-size: 12px; margin-top: 15px; font-style: italic;">
                        âš ï¸ æ³¨æ„ï¼šæ­¤é æ¸¬åƒ…ä¾›åƒè€ƒï¼Œå½©ç¥¨çµæœå…·æœ‰éš¨æ©Ÿæ€§ï¼Œç„¡æ³•ä¿è­‰é æ¸¬æº–ç¢ºæ€§ã€‚
                    </p>
                </div>
            `;

            container.innerHTML = html;
        }

        // åˆ‡æ›è¤‡å¼æŠ•æ³¨é¸é …çš„å±•é–‹/æ”¶èµ·
        function toggleCompoundBet(cardId) {
            const card = document.getElementById(cardId);
            const arrow = document.getElementById('arrow-' + cardId);
            if (card && arrow) {
                const isExpanded = card.style.display !== 'none';
                card.style.display = isExpanded ? 'none' : 'block';
                // æ›´æ–°ç®­é ­åœ–æ¨™
                arrow.textContent = isExpanded ? 'â–¶' : 'â–¼';
            }
        }
    </script>
</body>

</html>