<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…­åˆå½©æ”ªç çµæœ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .button-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .year-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .year-selector label {
            color: #333;
            font-weight: 600;
            font-size: 16px;
        }

        .year-selector input {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 120px;
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .year-selector input:focus {
            outline: none;
            border-color: #667eea;
        }

        .fetch-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .fetch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .fetch-button:active {
            transform: translateY(0);
        }

        .fetch-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #analysisButton {
            display: none;
            margin: 15px auto 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c33;
        }

        .results-container {
            margin-top: 30px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover {
            background: #f5f5f5;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .number-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 2px;
            font-weight: 600;
        }

        .stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .stats p {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å…­åˆå½©æ”ªç çµæœ</h1>
        
        <div class="button-container">
            <div class="year-selector">
                <label for="startYear">å¹´ä»½ï¼š</label>
                <input type="number" id="startYear" min="2000" max="2100" value="">
                <label for="endYear">è‡³</label>
                <input type="number" id="endYear" min="2000" max="2100" value="">
            </div>
            <button class="fetch-button" id="fetchButton" onclick="fetchLotteryResults()">
                å–å¾—æ”ªç çµæœ
            </button>
            <button class="fetch-button" id="analysisButton" onclick="showAnalysis()">
                åˆ†æ
            </button>
            <button class="fetch-button" id="validateButton" onclick="showValidation()" style="display: none;">
                è¿­ä»£é©—è­‰
            </button>
            <button class="fetch-button" id="predictButton" onclick="showLatestPrediction()" style="display: none; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                ğŸ¯ æœ€æ–°é æ¸¬
            </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            æ­£åœ¨å–å¾—è³‡æ–™...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="resultsContainer" class="results-container"></div>
    </div>

    <script>
        // å„²å­˜ç•¶å‰çµæœè³‡æ–™
        let currentResults = [];

        // åˆå§‹åŒ–å¹´ä»½é¸æ“‡å™¨ï¼Œé è¨­ç‚ºä»Šå¹´
        document.addEventListener('DOMContentLoaded', function() {
            const currentYear = new Date().getFullYear();
            document.getElementById('startYear').value = currentYear;
            document.getElementById('endYear').value = currentYear;
        });

        async function fetchLotteryResults() {
            const button = document.getElementById('fetchButton');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const startYear = document.getElementById('startYear').value;
            const endYear = document.getElementById('endYear').value;

            // é©—è­‰å¹´ä»½è¼¸å…¥
            if (!startYear || !endYear) {
                error.textContent = 'éŒ¯èª¤: è«‹è¼¸å…¥é–‹å§‹å¹´ä»½å’ŒçµæŸå¹´ä»½';
                error.style.display = 'block';
                return;
            }

            if (parseInt(startYear) > parseInt(endYear)) {
                error.textContent = 'éŒ¯èª¤: é–‹å§‹å¹´ä»½ä¸èƒ½å¤§æ–¼çµæŸå¹´ä»½';
                error.style.display = 'block';
                return;
            }

            // é‡ç½®ç‹€æ…‹
            button.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            resultsContainer.innerHTML = '';
            // Hide analysis, validation and prediction buttons when fetching new data
            document.getElementById('analysisButton').style.display = 'none';
            document.getElementById('validateButton').style.display = 'none';
            document.getElementById('predictButton').style.display = 'none';

            try {
                const url = `/api/lottery/results?startYear=${startYear}&endYear=${endYear}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    // å„²å­˜çµæœè³‡æ–™ä¾›åˆ†æä½¿ç”¨
                    currentResults = data.data;
                    displayResults(data.data, data.count);
                    // Show analysis, validation and prediction buttons after successful fetch
                    document.getElementById('analysisButton').style.display = 'block';
                    document.getElementById('validateButton').style.display = 'block';
                    document.getElementById('predictButton').style.display = 'block';
                } else {
                    throw new Error(data.message || 'å–å¾—è³‡æ–™å¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayResults(results, count) {
            const container = document.getElementById('resultsContainer');

            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš«ç„¡è³‡æ–™</p>';
                return;
            }

            let html = `
                <div class="stats">
                    <p><strong>å…±å–å¾— ${count} ç­†è¨˜éŒ„</strong></p>
                </div>
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>æ”ªç æœŸæ•¸</th>
                            <th>æ”ªç æ—¥æœŸ</th>
                            <th>æ”ªå‡ºè™Ÿç¢¼</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(result => {
                // Extract numbers from the string format
                let numberArray = [];
                if (result.numbers && result.numbers.length > 0) {
                    if (typeof result.numbers[0] === 'string') {
                        // Split by newlines and tabs, filter out empty strings, and parse numbers
                        numberArray = result.numbers[0]
                            .split(/[\n\t]+/)
                            .filter(str => str.trim() !== '')
                            .map(str => parseInt(str.trim(), 10))
                            .filter(num => !isNaN(num));
                    } else {
                        // If it's already an array of numbers, use it directly
                        numberArray = result.numbers;
                    }
                }
                
                const numbers = numberArray.map(num => 
                    `<span class="number-badge">${num}</span>`
                ).join('');

                html += `
                    <tr>
                        <td>${result.periodNumber}</td>
                        <td>${result.date}</td>
                        <td>${numbers || 'ç„¡'}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        async function showAnalysis() {
            const analysisButton = document.getElementById('analysisButton');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (currentResults.length === 0) {
                error.textContent = 'éŒ¯èª¤: è«‹å…ˆå–å¾—æ”ªç çµæœ';
                error.style.display = 'block';
                return;
            }
            
            // é‡ç½®ç‹€æ…‹
            analysisButton.disabled = true;
            error.style.display = 'none';
            
            try {
                const response = await fetch('/api/lottery/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResults(data.data);
                } else {
                    throw new Error(data.message || 'åˆ†æå¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                analysisButton.disabled = false;
            }
        }
        
        function displayAnalysisResults(analysisData) {
            const container = document.getElementById('resultsContainer');
            
            let html = `
                <div class="stats">
                    <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š åˆ†æçµæœ</h2>
                    <p><strong>åˆ†ææœŸæ•¸:</strong> ${analysisData.stats.totalPeriods} æœŸ</p>
                    <p><strong>ç¸½æŠ½ä¸­æ¬¡æ•¸:</strong> ${analysisData.stats.totalNumbers} æ¬¡</p>
                    <p><strong>å¹³å‡å‡ºç¾é »ç‡:</strong> ${Math.round(analysisData.stats.averageFrequency * 100) / 100} æ¬¡/è™Ÿç¢¼</p>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">
                        ğŸ¯ é æ¸¬ä¸‹ä¸€æœŸæœ€æœ‰å¯èƒ½å‡ºç¾çš„ 10 å€‹è™Ÿç¢¼
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;">
            `;
            
            // é¡¯ç¤ºå‰ 10 åè™Ÿç¢¼
            analysisData.topNumbers.forEach((item, index) => {
                const rank = index + 1;
                const size = rank <= 3 ? '25px' : '20px'; // å‰ä¸‰åç¨å¤§
                const bgColor = rank === 1 ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                                rank === 2 ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' :
                                rank === 3 ? 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' :
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                html += `
                    <div style="
                        background: ${bgColor};
                        color: white;
                        padding: 20px;
                        border-radius: 15px;
                        text-align: center;
                        min-width: 120px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        transition: transform 0.3s ease;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">æ’å #${rank}</div>
                        <div style="font-size: ${size}; font-weight: bold; margin: 10px 0;">${item.number}</div>
                        <div style="font-size: 11px; opacity: 0.8;">ç¶œåˆåˆ†æ•¸: ${item.score}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“ˆ è©³ç´°çµ±è¨ˆ</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>è™Ÿç¢¼</th>
                                <th>ç¶œåˆåˆ†æ•¸</th>
                                <th>ç¸½å‡ºç¾æ¬¡æ•¸</th>
                                <th>åŠ æ¬Šé »ç‡</th>
                                <th>é–“éš”åˆ†æ•¸</th>
                                <th>æ¨¡å¼åˆ†æ•¸</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            analysisData.topNumbers.forEach((item, index) => {
                html += `
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td><span class="number-badge" style="font-size: 16px;">${item.number}</span></td>
                        <td>${item.score}</td>
                        <td>${item.frequency}</td>
                        <td>${item.weightedFrequency}</td>
                        <td>${item.gapScore}</td>
                        <td>${item.patternScore}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š åˆ†ææ–¹æ³•èªªæ˜</h3>
                    <p style="color: #666; line-height: 1.8; margin-bottom: 10px;">
                        <strong>ç¶œåˆåˆ†æ•¸è¨ˆç®—æ–¹å¼:</strong>
                    </p>
                    <ul style="color: #666; line-height: 1.8; margin-left: 20px;">
                        <li><strong>é »ç‡åˆ†æ (30%):</strong> çµ±è¨ˆæ¯å€‹è™Ÿç¢¼åœ¨æ­·å²è³‡æ–™ä¸­çš„ç¸½å‡ºç¾æ¬¡æ•¸</li>
                        <li><strong>åŠ æ¬Šé »ç‡ (35%):</strong> è¿‘æœŸå‡ºç¾çš„è™Ÿç¢¼çµ¦äºˆæ›´é«˜æ¬Šé‡ï¼Œåæ˜ è¶¨å‹¢è®ŠåŒ–</li>
                        <li><strong>é–“éš”åˆ†æ (20%):</strong> åˆ†æè™Ÿç¢¼å¤šä¹…æ²’å‡ºç¾ï¼Œé–“éš”è¶Šé•·è¡¨ç¤ºå¯èƒ½"è©²å‡ºç¾äº†"</li>
                        <li><strong>æ¨¡å¼åˆ†æ (15%):</strong> åˆ†ææœ€è¿‘å¹¾æœŸçš„å‡ºç¾æ¨¡å¼ï¼Œæ•æ‰çŸ­æœŸè¶¨å‹¢</li>
                    </ul>
                    <p style="color: #999; font-size: 12px; margin-top: 15px; font-style: italic;">
                        âš ï¸ æ³¨æ„ï¼šæ­¤åˆ†æåƒ…ä¾›åƒè€ƒï¼Œå½©ç¥¨çµæœå…·æœ‰éš¨æ©Ÿæ€§ï¼Œç„¡æ³•ä¿è­‰é æ¸¬æº–ç¢ºæ€§ã€‚
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function showValidation() {
            const validateButton = document.getElementById('validateButton');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            
            if (currentResults.length === 0) {
                error.textContent = 'éŒ¯èª¤: è«‹å…ˆå–å¾—æ”ªç çµæœ';
                error.style.display = 'block';
                return;
            }
            
            // é‡ç½®ç‹€æ…‹
            validateButton.disabled = true;
            error.style.display = 'none';
            loading.style.display = 'block';
            loading.textContent = 'æ­£åœ¨é€²è¡Œè¿­ä»£é©—è­‰...';
            
            try {
                const response = await fetch('/api/lottery/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults,
                        lookbackPeriods: 10
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayValidationResults(data.data);
                } else {
                    throw new Error(data.message || 'è¿­ä»£é©—è­‰å¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                validateButton.disabled = false;
                loading.style.display = 'none';
            }
        }

        // å„²å­˜é©—è­‰å¾Œçš„æœ€çµ‚æ¬Šé‡ï¼ˆå¦‚æœé€²è¡Œäº†è¿­ä»£é©—è­‰ï¼‰
        let optimizedWeights = null;

        function displayValidationResults(validationData) {
            // ä¿å­˜å„ªåŒ–å¾Œçš„æ¬Šé‡ç”¨æ–¼é æ¸¬
            optimizedWeights = validationData.finalWeights;
            
            const container = document.getElementById('resultsContainer');
            
            let html = `
                <div class="stats">
                    <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ”„ è¿­ä»£é©—è­‰çµæœ</h2>
                    <p><strong>æœ€æ–°æœŸæ•¸:</strong> ${validationData.latestPeriod}</p>
                    <p><strong>é–‹å§‹æœŸæ•¸:</strong> ${validationData.startPeriod}</p>
                    <p><strong>é©—è­‰æ¬¡æ•¸:</strong> ${validationData.totalValidations} æ¬¡</p>
                </div>
                
                <div style="margin-top: 30px; background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“Š ç¸½é«”çµ±è¨ˆ</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç¸½å‘½ä¸­æ•¸</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${validationData.statistics.totalHits}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡æ¯æœŸå‘½ä¸­æ•¸</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${Math.round(validationData.statistics.averageHitsPerPeriod * 100) / 100}</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡æº–ç¢ºç‡</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${validationData.statistics.averageAccuracy}%</div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡è¦†è“‹ç‡</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${validationData.statistics.averageCoverage}%</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #333; margin-bottom: 15px;">âš™ï¸ æœ€çµ‚èª¿æ•´å¾Œçš„æ¬Šé‡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">é »ç‡</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.frequency * 100)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">åŠ æ¬Šé »ç‡</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.weightedFrequency * 100)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">é–“éš”</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.gap * 100)}%</div>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 12px; color: #666;">æ¨¡å¼</div>
                            <div style="font-size: 18px; font-weight: bold; color: #333;">${Math.round(validationData.finalWeights.pattern * 100)}%</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 20px; font-size: 1.5em;">ğŸ“‹ è©³ç´°é©—è­‰è¨˜éŒ„</h3>
                    <div style="overflow-x: auto;">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th>è¨“ç·´æœŸæ•¸</th>
                                    <th>ç›®æ¨™æœŸæ•¸</th>
                                    <th>é æ¸¬è™Ÿç¢¼</th>
                                    <th>å¯¦éš›è™Ÿç¢¼</th>
                                    <th>å‘½ä¸­æ•¸</th>
                                    <th>æº–ç¢ºç‡</th>
                                    <th>è¦†è“‹ç‡</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            validationData.validationResults.forEach((result, index) => {
                const hitCount = result.comparison.hitCount;
                const accuracy = result.comparison.accuracy;
                const coverage = result.comparison.coverage;
                
                // å‘½ä¸­æ•¸çš„é¡è‰²æ¨™è¨˜
                const hitColor = hitCount >= 3 ? '#28a745' : hitCount >= 1 ? '#ffc107' : '#dc3545';
                
                // æ ¼å¼åŒ–è™Ÿç¢¼é¡¯ç¤º
                const predictedNumbers = result.predictedNumbers.map(num => 
                    `<span class="number-badge" style="background: ${result.comparison.hits.includes(num) ? '#28a745' : '#667eea'}">${num}</span>`
                ).join('');
                
                const actualNumbers = result.actualNumbers.map(num => 
                    `<span class="number-badge">${num}</span>`
                ).join('');
                
                html += `
                    <tr>
                        <td><strong>${result.trainingPeriod}</strong></td>
                        <td><strong>${result.targetPeriod}</strong></td>
                        <td>${predictedNumbers || 'ç„¡'}</td>
                        <td>${actualNumbers || 'ç„¡'}</td>
                        <td style="color: ${hitColor}; font-weight: bold; font-size: 18px;">${hitCount}</td>
                        <td>${Math.round(accuracy * 100) / 100}%</td>
                        <td>${Math.round(coverage * 100) / 100}%</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“– é©—è­‰èªªæ˜</h3>
                    <ul style="color: #666; line-height: 1.8; margin-left: 20px;">
                        <li><strong>è¨“ç·´æœŸæ•¸:</strong> ç”¨æ–¼åˆ†æçš„æ­·å²è³‡æ–™æˆªæ­¢æœŸæ•¸</li>
                        <li><strong>ç›®æ¨™æœŸæ•¸:</strong> è¦é æ¸¬çš„æœŸæ•¸</li>
                        <li><strong>å‘½ä¸­æ•¸:</strong> é æ¸¬è™Ÿç¢¼ä¸­å¯¦éš›é–‹å‡ºçš„è™Ÿç¢¼æ•¸é‡</li>
                        <li><strong>æº–ç¢ºç‡:</strong> å‘½ä¸­æ•¸ / é æ¸¬è™Ÿç¢¼ç¸½æ•¸ Ã— 100%</li>
                        <li><strong>è¦†è“‹ç‡:</strong> å‘½ä¸­æ•¸ / å¯¦éš›é–‹å‡ºè™Ÿç¢¼ç¸½æ•¸ Ã— 100%</li>
                        <li><strong>æ¬Šé‡èª¿æ•´:</strong> ç³»çµ±æœƒæ ¹æ“šæ¯æœŸçš„é©—è­‰çµæœè‡ªå‹•èª¿æ•´åˆ†ææ¬Šé‡ï¼Œä»¥å„ªåŒ–é æ¸¬æ•ˆæœ</li>
                    </ul>
                    <p style="color: #999; font-size: 12px; margin-top: 15px; font-style: italic;">
                        ğŸ’¡ æç¤ºï¼šç¶ è‰²æ¨™è¨˜çš„é æ¸¬è™Ÿç¢¼è¡¨ç¤ºæˆåŠŸå‘½ä¸­ï¼Œç´«è‰²è¡¨ç¤ºæœªå‘½ä¸­ã€‚
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
        }

        async function showLatestPrediction() {
            const predictButton = document.getElementById('predictButton');
            const error = document.getElementById('error');
            const resultsContainer = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            
            if (currentResults.length === 0) {
                error.textContent = 'éŒ¯èª¤: è«‹å…ˆå–å¾—æ”ªç çµæœ';
                error.style.display = 'block';
                return;
            }
            
            // é‡ç½®ç‹€æ…‹
            predictButton.disabled = true;
            error.style.display = 'none';
            loading.style.display = 'block';
            loading.textContent = 'æ­£åœ¨åˆ†æä¸¦é æ¸¬ä¸‹ä¸€æœŸè™Ÿç¢¼...';
            
            try {
                // ä½¿ç”¨æ‰€æœ‰æ­·å²æ•¸æ“šé€²è¡Œé æ¸¬
                const response = await fetch('/api/lottery/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults,
                        weights: optimizedWeights // å¦‚æœé€²è¡Œäº†è¿­ä»£é©—è­‰ï¼Œä½¿ç”¨å„ªåŒ–å¾Œçš„æ¬Šé‡
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayLatestPrediction(data.data, currentResults[0]);
                } else {
                    throw new Error(data.message || 'é æ¸¬å¤±æ•—');
                }
            } catch (err) {
                error.textContent = 'éŒ¯èª¤: ' + err.message;
                error.style.display = 'block';
            } finally {
                predictButton.disabled = false;
                loading.style.display = 'none';
            }
        }

        function displayLatestPrediction(analysisData, latestResult) {
            const container = document.getElementById('resultsContainer');
            
            // ç²å–æœ€æ–°æœŸæ•¸
            const latestPeriod = latestResult.periodNumber;
            
            // è§£ææœŸæ•¸ä»¥è¨ˆç®—ä¸‹ä¸€æœŸ
            const parsePeriod = (periodStr) => {
                const match1 = periodStr.match(/^(\d{2})\/(\d+)$/);
                if (match1) {
                    return { year: parseInt(match1[1], 10), period: parseInt(match1[2], 10) };
                }
                const match2 = periodStr.match(/^(\d{4})(\d{3})$/);
                if (match2) {
                    return { year: parseInt(match2[1], 10), period: parseInt(match2[2], 10) };
                }
                return null;
            };
            
            const currentPeriod = parsePeriod(latestPeriod);
            let nextPeriodStr = 'ä¸‹ä¸€æœŸ';
            if (currentPeriod) {
                const nextPeriod = currentPeriod.period + 1;
                if (latestPeriod.includes('/')) {
                    nextPeriodStr = `${currentPeriod.year}/${nextPeriod}`;
                } else {
                    nextPeriodStr = `${currentPeriod.year}${String(nextPeriod).padStart(3, '0')}`;
                }
            }
            
            let html = `
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px; color: white; text-align: center; box-shadow: 0 6px 25px rgba(0, 0, 0, 0.2);">
                    <h2 style="margin: 0 0 10px 0; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">ğŸ¯ æœ€æ–°é æ¸¬</h2>
                    <p style="margin: 0; font-size: 1.3em; opacity: 0.95;">åŸºæ–¼ ${analysisData.stats.totalPeriods} æœŸæ­·å²æ•¸æ“šåˆ†æ</p>
                    <p style="margin: 15px 0 0 0; font-size: 1.2em; opacity: 0.9;">é æ¸¬æœŸæ•¸: <strong style="font-size: 1.3em;">${nextPeriodStr}</strong></p>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3 style="color: #333; margin-bottom: 25px; font-size: 1.8em; text-align: center;">
                        ğŸ“Š é æ¸¬æœ€æœ‰å¯èƒ½å‡ºç¾çš„ 15 å€‹è™Ÿç¢¼
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 30px;">
            `;
            
            // é¡¯ç¤ºå‰ 15 åè™Ÿç¢¼ï¼ˆæ ¹æ“šæœ€æ–°åˆ†æçµæœï¼‰
            analysisData.topNumbers.forEach((item, index) => {
                const rank = index + 1;
                const size = rank <= 3 ? '35px' : rank <= 5 ? '28px' : '22px';
                const bgColor = rank === 1 ? 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' :
                                rank === 2 ? 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' :
                                rank === 3 ? 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)' :
                                rank <= 5 ? 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' :
                                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                
                const borderStyle = rank <= 3 ? '3px solid #fff' : '2px solid #fff';
                const shadowStyle = rank <= 3 ? '0 6px 25px rgba(0, 0, 0, 0.3)' : '0 4px 15px rgba(0, 0, 0, 0.2)';
                
                html += `
                    <div style="
                        background: ${bgColor};
                        color: white;
                        padding: 25px;
                        border-radius: 15px;
                        text-align: center;
                        min-width: 140px;
                        box-shadow: ${shadowStyle};
                        border: ${borderStyle};
                        transition: transform 0.3s ease;
                        position: relative;
                    " onmouseover="this.style.transform='scale(1.1)'; this.style.zIndex='10';" 
                       onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';">
                        ${rank <= 3 ? `<div style="position: absolute; top: -10px; right: -10px; background: #ffd700; color: #333; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'}</div>` : ''}
                        <div style="font-size: 11px; opacity: 0.9; margin-bottom: 8px; font-weight: 600;">æ’å #${rank}</div>
                        <div style="font-size: ${size}; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">${String(item.number).padStart(2, '0')}</div>
                        <div style="font-size: 12px; opacity: 0.85; margin-top: 5px;">åˆ†æ•¸: ${item.score}</div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="margin-top: 30px; background: #f8f9fa; padding: 25px; border-radius: 10px;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ“ˆ è©³ç´°åˆ†æ</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>è™Ÿç¢¼</th>
                                <th>ç¶œåˆåˆ†æ•¸</th>
                                <th>ç¸½å‡ºç¾æ¬¡æ•¸</th>
                                <th>åŠ æ¬Šé »ç‡</th>
                                <th>é–“éš”åˆ†æ•¸</th>
                                <th>æ¨¡å¼åˆ†æ•¸</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            analysisData.topNumbers.forEach((item, index) => {
                html += `
                    <tr>
                        <td><strong>#${index + 1}</strong></td>
                        <td><span class="number-badge" style="font-size: 18px; font-weight: bold;">${String(item.number).padStart(2, '0')}</span></td>
                        <td><strong>${item.score}</strong></td>
                        <td>${item.frequency}</td>
                        <td>${item.weightedFrequency}</td>
                        <td>${item.gapScore}</td>
                        <td>${item.patternScore}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 30px; background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h3 style="color: #333; margin-bottom: 15px;">ğŸ’¡ é æ¸¬èªªæ˜</h3>
                    <ul style="color: #666; line-height: 1.8; margin-left: 20px;">
                        <li>æ­¤é æ¸¬åŸºæ–¼ <strong>${analysisData.stats.totalPeriods}</strong> æœŸæ­·å²æ•¸æ“šé€²è¡Œåˆ†æ</li>
                        <li>ä½¿ç”¨å¤šç¨®çµ±è¨ˆæ–¹æ³•ç¶œåˆè©•ä¼°ï¼šé »ç‡åˆ†æã€åŠ æ¬Šé »ç‡ã€é–“éš”åˆ†æã€æ¨¡å¼åˆ†æ</li>
                        <li>è™Ÿç¢¼æŒ‰ç¶œåˆåˆ†æ•¸æ’åºï¼Œåˆ†æ•¸è¶Šé«˜è¡¨ç¤ºå‡ºç¾æ©Ÿç‡è¶Šå¤§</li>
                        ${optimizedWeights ? '<li style="color: #28a745;"><strong>âœ“ å·²ä½¿ç”¨è¿­ä»£é©—è­‰å„ªåŒ–å¾Œçš„æ¬Šé‡åƒæ•¸</strong></li>' : '<li>å»ºè­°å…ˆé€²è¡Œã€Œè¿­ä»£é©—è­‰ã€ä»¥å„ªåŒ–é æ¸¬åƒæ•¸</li>'}
                    </ul>
                    <p style="color: #999; font-size: 12px; margin-top: 15px; font-style: italic;">
                        âš ï¸ æ³¨æ„ï¼šæ­¤é æ¸¬åƒ…ä¾›åƒè€ƒï¼Œå½©ç¥¨çµæœå…·æœ‰éš¨æ©Ÿæ€§ï¼Œç„¡æ³•ä¿è­‰é æ¸¬æº–ç¢ºæ€§ã€‚
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>

